<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sessiz Sinyal V4 - PDF Raporlu + Kamera Nabƒ±z</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #121212;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #1e1e2e;
      padding: 20px;
      border-radius: 10px;
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 1em;
      border: none;
      border-radius: 6px;
    }
    button {
      background: #2196f3;
      color: white;
      cursor: pointer;
    }
    h2, h3 {
      text-align: center;
      color: #4fc3f7;
    }
    .output {
      margin-top: 10px;
      font-weight: bold;
      color: #ffcc80;
    }
    canvas {
      margin-top: 20px;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .stat-box {
      background: #263238;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 5px;
      flex: 1 1 45%;
      text-align: center;
    }
    .filter-box {
      margin-top: 20px;
      background: #2e2e3e;
      padding: 15px;
      border-radius: 8px;
    }
    #video {
      width: 100%;
      border-radius: 10px;
      margin-top: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Sessiz Sinyal V4</h2>
    <input type="text" id="name" placeholder="Adƒ±nƒ±zƒ± girin..." />
    <button onclick="startCamera()">Kameradan Nabƒ±z √ñl√ß</button>
    <button onclick="start()">Veri √úret ve G√∂nder</button>
    <button onclick="downloadCSV()">CSV Aktar</button>
    <button onclick="generatePDF()">PDF Rapor ƒ∞ndir</button>
    <video id="video" autoplay></video>
    <div class="output" id="pulseOutput">Nabƒ±z: --</div>
    <div class="output" id="reactionOutput">Tepki S√ºresi: --</div>
    <div class="output" id="aiComment">AI Yorum: --</div>
    <div class="stats">
      <div class="stat-box" id="totalUsers">üë• Kullanƒ±cƒ±: 0</div>
      <div class="stat-box" id="avgPulse">‚ù§Ô∏è Ortalama Nabƒ±z: --</div>
      <div class="stat-box" id="avgReaction">‚ö° Ortalama Tepki: --</div>
    </div>
    <div class="filter-box">
      <h3>Filtreleme</h3>
      <input type="text" id="filterName" placeholder="Ad ile filtrele..." oninput="filterData()" />
      <select id="filterStress" onchange="filterData()">
        <option value="">T√ºm Stres Seviyeleri</option>
        <option value="y√ºksek">Y√ºksek Stres</option>
        <option value="normal">Normal</option>
      </select>
    </div>
    <canvas id="pulseChart" height="200"></canvas>
    <canvas id="reactionChart" height="200"></canvas>
  </div>

  <script>
    let pulse = 0;
    let reaction = 0;
    let aiComment = "";
    let allData = [];

    async function startCamera() {
      const video = document.getElementById("video");
      video.style.display = "block";
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
      video.srcObject = stream;

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      let bpmList = [];
      let previousAvg = null;
      let lastTime = Date.now();

      function analyzeFrame() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let sum = 0;
        for (let i = 0; i < frame.data.length; i += 4) {
          sum += frame.data[i];
        }
        const avg = sum / (frame.data.length / 4);

        if (previousAvg !== null) {
          const diff = avg - previousAvg;
          if (Math.abs(diff) > 0.5) {
            const now = Date.now();
            const bpm = 60000 / (now - lastTime);
            lastTime = now;
            bpmList.push(bpm);
            if (bpmList.length > 5) bpmList.shift();
            const avgBpm = Math.round(bpmList.reduce((a, b) => a + b, 0) / bpmList.length);
            pulse = avgBpm;
            document.getElementById("pulseOutput").textContent = "Nabƒ±z: " + avgBpm + " (kamera)";
          }
        }
        previousAvg = avg;
        requestAnimationFrame(analyzeFrame);
      }
      requestAnimationFrame(analyzeFrame);
    }

    function simulateData() {
      if (pulse === 0) pulse = Math.floor(Math.random() * 40 + 70);
      reaction = Math.floor(Math.random() * 800 + 300);
      document.getElementById("reactionOutput").textContent = "Tepki S√ºresi: " + reaction + " ms";
    }

    function analyzeAI(p, r) {
      if (p > 100 && r > 800) return "Y√ºksek Stres / D√º≈ü√ºk Odak";
      if (p >= 70 && r >= 500) return "Orta Seviye / Dengeli";
      return "Sakin ve Odaklƒ±";
    }

    async function start() {
      const name = document.getElementById("name").value.trim();
      if (!name) return alert("L√ºtfen adƒ±nƒ±zƒ± girin.");

      simulateData();
      aiComment = analyzeAI(pulse, reaction);
      document.getElementById("aiComment").textContent = "AI Yorum: " + aiComment;

      const payload = { name, pulse, reaction, comment: aiComment, timestamp: new Date().toISOString() };
      try {
        await fetch("https://sessizsinyal-api.onrender.com/api/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        loadData();
      } catch (e) {
        console.error("G√∂nderim ba≈üarƒ±sƒ±z:", e);
      }
    }

    async function loadData() {
      try {
        const res = await fetch("https://sessizsinyal-api.onrender.com/api/all");
        allData = await res.json();
        updateStats(allData);
        drawChart(allData);
      } catch (e) {
        console.error("Veri y√ºklenemedi:", e);
      }
    }

    function updateStats(data) {
      const uniqueUsers = [...new Set(data.map(d => d.name))].length;
      const avgPulse = (data.reduce((a, b) => a + b.pulse, 0) / data.length).toFixed(1);
      const avgReaction = (data.reduce((a, b) => a + b.reaction, 0) / data.length).toFixed(1);
      document.getElementById("totalUsers").textContent = "üë• Kullanƒ±cƒ±: " + uniqueUsers;
      document.getElementById("avgPulse").textContent = "‚ù§Ô∏è Ortalama Nabƒ±z: " + avgPulse;
      document.getElementById("avgReaction").textContent = "‚ö° Ortalama Tepki: " + avgReaction;
    }

    function drawChart(data) {
      const ctxPulse = document.getElementById("pulseChart").getContext("2d");
      const ctxReaction = document.getElementById("reactionChart").getContext("2d");
      if (window.chartPulse) window.chartPulse.destroy();
      if (window.chartReaction) window.chartReaction.destroy();
      const labels = data.map((d, i) => d.name + " " + (i + 1));
      const pulseData = data.map(d => d.pulse);
      const reactionData = data.map(d => d.reaction);
      window.chartPulse = new Chart(ctxPulse, {
        type: 'line', data: { labels, datasets: [{ label: 'Nabƒ±z', data: pulseData, borderColor: '#4fc3f7', fill: false }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
      window.chartReaction = new Chart(ctxReaction, {
        type: 'bar', data: { labels, datasets: [{ label: 'Tepki', data: reactionData, backgroundColor: '#ffca28' }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    function filterData() {
      const nameFilter = document.getElementById("filterName").value.toLowerCase();
      const stressFilter = document.getElementById("filterStress").value;
      const filtered = allData.filter(entry => {
        const matchName = entry.name.toLowerCase().includes(nameFilter);
        const matchStress =
          stressFilter === "y√ºksek" ? entry.pulse > 100 :
          stressFilter === "normal" ? entry.pulse <= 100 && entry.pulse >= 70 : true;
        return matchName && matchStress;
      });
      updateStats(filtered);
      drawChart(filtered);
    }

    function downloadCSV() {
      let csv = "Ad,Nabƒ±z,Tepki,AI Yorum,Tarih\n";
      allData.forEach(row => {
        csv += `${row.name},${row.pulse},${row.reaction},"${row.comment}",${row.timestamp}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "sessiz_sinyal_verileri.csv";
      link.click();
    }

    function generatePDF() {
      const name = document.getElementById("name").value.trim();
      const date = new Date().toLocaleDateString("tr-TR");
      if (!name || !pulse || !reaction || !aiComment) return alert("L√ºtfen √∂nce veri √ºretin ve g√∂nderin.");
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("\ud83d\udcc4 Sessiz Sinyal AI Raporu", 20, 20);
      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text(`\ud83d\udc64 Ad: ${name}`, 20, 40);
      doc.text(`‚ù§Ô∏è Nabƒ±z: ${pulse} bpm`, 20, 50);
      doc.text(`‚ö° Tepki S√ºresi: ${reaction} ms`, 20, 60);
      doc.text(`üß† Yorum: ${aiComment}`, 20, 70);
      doc.text(`üìÖ Tarih: ${date}`, 20, 85);
      doc.text(`üîê Doƒürulandƒ±: SessizSinyal AI Sistemi`, 20, 95);
      doc.save(`sessiz_sinyal_raporu_${name}.pdf`);
    }

    window.onload = loadData;
  </script>
</body>
</html>